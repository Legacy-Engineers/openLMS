{% extends 'base.html' %}
{% load static %}

{% block title %}Reports - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .report-card {
        border-left: 4px solid #28a745;
        transition: all 0.3s ease;
    }
    .report-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .report-status {
        font-size: 0.85rem;
        font-weight: 500;
    }
    .report-type {
        background: #f8f9fa;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Generated Reports
                    </h5>
                    <div>
                        <a href="{% url 'reports:template_list' %}" class="btn btn-secondary me-2">
                            <i class="fas fa-file-alt me-1"></i>
                            Report Templates
                        </a>
                        <a href="{% url 'reports:report_generate' %}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>
                            Generate Report
                        </a>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">Total Reports</h6>
                                            <h4 class="mb-0" id="totalReports">{{ reports.count }}</h4>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-file-alt fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">Completed</h6>
                                            <h4 class="mb-0" id="completedReports">{{ reports|length }}</h4>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-check-circle fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">Processing</h6>
                                            <h4 class="mb-0" id="processingReports">0</h4>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-clock fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6 class="card-title">Failed</h6>
                                            <h4 class="mb-0" id="failedReports">0</h4>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reports List -->
                    <div class="row" id="reportsList">
                        {% for report in reports %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card report-card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <span class="report-type">{{ report.template.get_report_type_display }}</span>
                                        </div>
                                        <div class="report-status">
                                            {% if report.status == 'completed' %}
                                                <span class="badge bg-success">Completed</span>
                                            {% elif report.status == 'generating' %}
                                                <span class="badge bg-warning">Generating</span>
                                            {% elif report.status == 'failed' %}
                                                <span class="badge bg-danger">Failed</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ report.status|title }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <h6 class="card-title">{{ report.title }}</h6>
                                    <p class="card-text text-muted small">
                                        Template: {{ report.template.name }}
                                    </p>
                                    
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            {{ report.generated_at|date:"M d, Y H:i" }}
                                        </small>
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'reports:report_detail' report.pk %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'reports:report_delete' report.pk %}" class="btn btn-sm btn-outline-danger" 
                                               onclick="return confirm('Are you sure you want to delete this report? This action cannot be undone.')">
                                                <i class="fas fa-trash-alt"></i>
                                            </a>
                                            {% if report.status == 'completed' %}
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-success dropdown-toggle" data-bs-toggle="dropdown">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" onclick="exportReport({{ report.pk }}, 'pdf')">PDF</a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="exportReport({{ report.pk }}, 'excel')">Excel</a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="exportReport({{ report.pk }}, 'csv')">CSV</a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="exportReport({{ report.pk }}, 'json')">JSON</a></li>
                                                </ul>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <div class="text-center py-5">
                                <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No reports generated yet</h5>
                                <p class="text-muted">Generate your first report to get started.</p>
                                <a href="{% url 'reports:report_generate' %}" class="btn btn-primary">
                                    <i class="fas fa-plus me-1"></i>
                                    Generate Report
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Pagination -->
                    {% if is_paginated %}
                    <nav aria-label="Reports pagination">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1">First</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                                </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">
                                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                </span>
                            </li>
                            
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-check-circle text-success me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Operation completed successfully!
        </div>
    </div>
</div>

<!-- Generate Report Modal -->
<div class="modal fade" id="generateReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line me-2"></i>
                    Generate Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="generateReportForm">
                    {% csrf_token %}
                    
                    <!-- Report Template Selection -->
                    <div class="mb-4">
                        <label for="templateSelect" class="form-label fw-bold">
                            <i class="fas fa-file-alt me-1"></i>
                            Report Template <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="templateSelect" name="template_id" required onchange="updateParameterFields()">
                            <option value="">Select a report template...</option>
                            <!-- Templates will be loaded via AJAX -->
                        </select>
                        <div class="form-text">Choose the type of report you want to generate.</div>
                    </div>
                    
                    <!-- Template Description -->
                    <div id="templateDescription" class="alert alert-info d-none">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="templateDescriptionText"></span>
                    </div>
                    
                    <!-- Dynamic parameter fields will be inserted here -->
                    <div id="dynamicParameters"></div>
                    
                    <!-- Date Range Section -->
                    <div id="dateRangeSection" class="mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-calendar-alt me-1"></i>
                            Date Range
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dateFrom" class="form-label">Date From</label>
                                    <input type="date" class="form-control" id="dateFrom" name="date_from">
                                    <div class="form-text" id="dateFromHelp">Start date for the report data</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dateTo" class="form-label">Date To</label>
                                    <input type="date" class="form-control" id="dateTo" name="date_to">
                                    <div class="form-text" id="dateToHelp">End date for the report data</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Report Configuration -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-cog me-1"></i>
                            Report Configuration
                        </h6>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="reportTitle" class="form-label">Custom Report Title</label>
                                    <input type="text" class="form-control" id="reportTitle" name="title" placeholder="Leave empty for auto-generated title">
                                    <div class="form-text">Optional custom title for this report</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="exportFormat" class="form-label">Export Format</label>
                                    <select class="form-select" id="exportFormat" name="export_format">
                                        <option value="">View only</option>
                                        <option value="pdf">PDF Download</option>
                                        <option value="excel">Excel Download</option>
                                        <option value="csv">CSV Download</option>
                                        <option value="json">JSON Download</option>
                                    </select>
                                    <div class="form-text">Generate downloadable file</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Validation Messages -->
                    <div id="validationMessages" class="alert alert-danger d-none">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <ul class="mb-0" id="validationList"></ul>
                    </div>
                    
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="generateReport()" id="generateReportBtn">
                    <i class="fas fa-chart-line me-1"></i>
                    Generate Report
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Store loaded templates and parameter configurations
let loadedTemplates = [];
let parameterConfigs = {};

// Define comprehensive parameter configurations for each report type
const REPORT_PARAMETER_CONFIGS = {
    'customer_statement': {
        title: 'Customer Statement Report',
        description: 'Generate a detailed statement for a specific customer showing order history, payments, and account status.',
        dateRequired: false,
        parameters: [
            {
                name: 'customer_id',
                type: 'select',
                label: 'Customer',
                required: true,
                placeholder: 'Select a customer...',
                helpText: 'The customer for whom to generate the statement',
                dataSource: 'customers',
                validation: { required: true, message: 'Please select a customer for the statement report.' }
            },
            {
                name: 'include_payments',
                type: 'checkbox',
                label: 'Include Payment History',
                defaultValue: true,
                helpText: 'Show detailed payment history in the statement'
            },
            {
                name: 'include_pending',
                type: 'checkbox',
                label: 'Include Pending Orders',
                defaultValue: true,
                helpText: 'Include orders that are still pending or in progress'
            }
        ]
    },
    'daily_sales': {
        title: 'Daily Sales Report',
        description: 'Comprehensive sales analysis with revenue breakdown, top services, and performance metrics.',
        dateRequired: false,
        parameters: [
            {
                name: 'scope',
                type: 'radio',
                label: 'Report Scope',
                required: true,
                defaultValue: 'today',
                options: [
                    { value: 'today', label: 'Today\'s Sales', description: 'Sales for the current day' },
                    { value: 'week', label: 'This Week', description: 'Sales for the current week' },
                    { value: 'month', label: 'This Month', description: 'Sales for the current month' },
                    { value: 'custom', label: 'Custom Date Range', description: 'Specify custom date range' }
                ],
                helpText: 'Choose the time period for the sales report'
            },
            {
                name: 'status_filter',
                type: 'select',
                label: 'Order Status',
                defaultValue: 'completed',
                options: [
                    { value: '', label: 'All Orders' },
                    { value: 'completed', label: 'Completed Orders' },
                    { value: 'pending', label: 'Pending Orders' },
                    { value: 'in_progress', label: 'In Progress Orders' },
                    { value: 'cancelled', label: 'Cancelled Orders' }
                ],
                helpText: 'Filter orders by their current status'
            },
            {
                name: 'include_analytics',
                type: 'checkbox',
                label: 'Include Advanced Analytics',
                defaultValue: true,
                helpText: 'Include charts, trends, and comparative analysis'
            }
        ]
    },
    'monthly_profit': {
        title: 'Monthly Profitability Report',
        description: 'Analyze revenue vs expenses with profit margins and monthly breakdown.',
        dateRequired: true,
        parameters: [
            {
                name: 'period',
                type: 'radio',
                label: 'Analysis Period',
                required: true,
                defaultValue: 'this_month',
                options: [
                    { value: 'this_month', label: 'This Month', description: 'Current month analysis' },
                    { value: 'last_month', label: 'Last Month', description: 'Previous month analysis' },
                    { value: 'quarter', label: 'This Quarter', description: 'Current quarter analysis' },
                    { value: 'custom', label: 'Custom Period', description: 'Specify custom date range' }
                ],
                helpText: 'Choose the time period for profit analysis'
            },
            {
                name: 'include_expenses',
                type: 'checkbox',
                label: 'Include Approved Expenses Only',
                defaultValue: true,
                helpText: 'Only include expenses that have been approved'
            },
            {
                name: 'breakdown_type',
                type: 'select',
                label: 'Breakdown Type',
                defaultValue: 'monthly',
                options: [
                    { value: 'monthly', label: 'Monthly Breakdown' },
                    { value: 'weekly', label: 'Weekly Breakdown' },
                    { value: 'daily', label: 'Daily Breakdown' }
                ],
                helpText: 'How to break down the profit analysis'
            }
        ]
    },
    'expense_summary': {
        title: 'Expense Summary Report',
        description: 'Analyze expenses by category, approval status, and amount ranges.',
        dateRequired: true,
        parameters: [
            {
                name: 'category_filter',
                type: 'select',
                label: 'Expense Category',
                placeholder: 'All Categories',
                dataSource: 'expense_categories',
                helpText: 'Filter expenses by category'
            },
            {
                name: 'approval_status',
                type: 'select',
                label: 'Approval Status',
                options: [
                    { value: '', label: 'All Expenses' },
                    { value: 'approved', label: 'Approved Only' },
                    { value: 'pending', label: 'Pending Approval' },
                    { value: 'rejected', label: 'Rejected' }
                ],
                helpText: 'Filter by approval status'
            },
            {
                name: 'min_amount',
                type: 'number',
                label: 'Minimum Amount',
                placeholder: '0.00',
                step: 0.01,
                helpText: 'Only include expenses above this amount'
            },
            {
                name: 'group_by',
                type: 'select',
                label: 'Group By',
                defaultValue: 'category',
                options: [
                    { value: 'category', label: 'Category' },
                    { value: 'month', label: 'Month' },
                    { value: 'approver', label: 'Approver' }
                ],
                helpText: 'How to group the expense data'
            }
        ]
    },
    'service_analysis': {
        title: 'Service Analysis Report',
        description: 'Analyze service performance, popularity, and revenue contribution.',
        dateRequired: false,
        parameters: [
            {
                name: 'service_category',
                type: 'select',
                label: 'Service Category',
                placeholder: 'All Categories',
                dataSource: 'service_categories',
                helpText: 'Filter services by category'
            },
            {
                name: 'analysis_type',
                type: 'radio',
                label: 'Analysis Type',
                required: true,
                defaultValue: 'revenue',
                options: [
                    { value: 'revenue', label: 'By Revenue', description: 'Analyze by total revenue generated' },
                    { value: 'pieces', label: 'By Pieces Count', description: 'Analyze by number of pieces processed' },
                    { value: 'orders', label: 'By Order Frequency', description: 'Analyze by how often services are ordered' }
                ],
                helpText: 'Choose the primary analysis metric'
            },
            {
                name: 'top_limit',
                type: 'select',
                label: 'Show Top',
                defaultValue: '10',
                options: [
                    { value: '10', label: 'Top 10' },
                    { value: '20', label: 'Top 20' },
                    { value: '50', label: 'Top 50' },
                    { value: 'all', label: 'All Services' }
                ],
                helpText: 'Number of top services to display'
            },
            {
                name: 'include_inactive',
                type: 'checkbox',
                label: 'Include Inactive Services',
                defaultValue: false,
                helpText: 'Include services that are no longer active'
            }
        ]
    },
    'custom': {
        title: 'Custom Report',
        description: 'Flexible report based on custom configuration.',
        dateRequired: false,
        parameters: [] // Will be populated dynamically based on template config
    }
};

// Load templates when modal opens
document.getElementById('generateReportModal').addEventListener('show.bs.modal', function() {
    loadTemplates();
    resetModal();
});

function resetModal() {
    // Clear form
    document.getElementById('generateReportForm').reset();
    
    // Clear dynamic parameters
    document.getElementById('dynamicParameters').innerHTML = '';
    
    // Hide validation messages
    document.getElementById('validationMessages').classList.add('d-none');
    
    // Hide template description
    document.getElementById('templateDescription').classList.add('d-none');
    
    // Reset button state
    const btn = document.getElementById('generateReportBtn');
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-chart-line me-1"></i> Generate Report';
}

function loadTemplates() {
    fetch('/reports/ajax/templates/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'  // Include session cookies
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            const select = document.getElementById('templateSelect');
            select.innerHTML = '<option value="">Select a report template...</option>';
            
            if (!data.success) {
                throw new Error(data.error || 'Failed to load templates');
            }
            
            // Store templates for later use
            loadedTemplates = data.results || [];
            
            if (loadedTemplates.length === 0) {
                select.innerHTML = '<option value="">No report templates available</option>';
                return;
            }
            
            // Group templates by type for better organization
            const templatesByType = {};
            loadedTemplates.forEach(template => {
                if (!templatesByType[template.report_type]) {
                    templatesByType[template.report_type] = [];
                }
                templatesByType[template.report_type].push(template);
            });
            
            // Add templates grouped by type
            Object.keys(templatesByType).forEach(type => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = templatesByType[type][0].report_type_display || type;
                
                templatesByType[type].forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    option.dataset.reportType = template.report_type;
                    option.dataset.description = template.description || '';
                    optgroup.appendChild(option);
                });
                
                select.appendChild(optgroup);
            });
            
            console.log(`Loaded ${loadedTemplates.length} report templates`);
        })
        .catch(error => {
            console.error('Error loading templates:', error);
            const select = document.getElementById('templateSelect');
            select.innerHTML = '<option value="">Error loading templates</option>';
            showError('Failed to load report templates. Please refresh the page and try again.');
        });
}

function updateParameterFields() {
    const templateSelect = document.getElementById('templateSelect');
    const selectedOption = templateSelect.options[templateSelect.selectedIndex];
    const dynamicParametersDiv = document.getElementById('dynamicParameters');
    const templateDescription = document.getElementById('templateDescription');
    const templateDescriptionText = document.getElementById('templateDescriptionText');
    
    // Clear existing parameters
    dynamicParametersDiv.innerHTML = '';
    templateDescription.classList.add('d-none');
    
    // Clear validation messages
    hideValidationMessages();
    
    if (selectedOption && selectedOption.value) {
        const reportType = selectedOption.dataset.reportType;
        const templateId = selectedOption.value;
        const template = loadedTemplates.find(t => t.id == templateId);
        
        // Show template description
        const config = REPORT_PARAMETER_CONFIGS[reportType];
        if (config) {
            templateDescriptionText.textContent = config.description;
            templateDescription.classList.remove('d-none');
            
            // Generate parameter fields
            generateParameterFields(config, template);
            
            // Update date field requirements
            updateDateFieldRequirements(config);
        }
    }
}

function generateParameterFields(config, template) {
    const dynamicParametersDiv = document.getElementById('dynamicParameters');
    let parametersHTML = '';
    
    if (config.parameters.length > 0) {
        parametersHTML += `
            <div class="mb-4">
                <h6 class="fw-bold mb-3">
                    <i class="fas fa-sliders-h me-1"></i>
                    ${config.title} Parameters
                </h6>
        `;
        
        config.parameters.forEach(param => {
            parametersHTML += generateParameterField(param, template);
        });
        
        parametersHTML += '</div>';
    }
    
    // Handle custom reports specially
    if (config.title === 'Custom Report' && template && template.config) {
        parametersHTML += generateCustomReportFields(template);
    }
    
    dynamicParametersDiv.innerHTML = parametersHTML;
    
    // Load data for select fields
    config.parameters.forEach(param => {
        if (param.dataSource) {
            loadParameterData(param.dataSource, param.name);
        }
    });
    
    // Add event listeners for dynamic fields
    addParameterEventListeners(config);
}

function generateParameterField(param, template) {
    let fieldHTML = '';
    const requiredMark = param.required ? '<span class="text-danger">*</span>' : '';
    const fieldId = param.name;
    
    fieldHTML += `<div class="mb-3">`;
    fieldHTML += `<label for="${fieldId}" class="form-label">${param.label} ${requiredMark}</label>`;
    
    switch (param.type) {
        case 'select':
            fieldHTML += `<select class="form-select" id="${fieldId}" name="${param.name}"`;
            if (param.required) fieldHTML += ' required';
            fieldHTML += `>`;
            
            if (param.dataSource) {
                fieldHTML += `<option value="">${param.placeholder || 'Loading...'}</option>`;
            } else if (param.options) {
                fieldHTML += `<option value="">${param.placeholder || 'Select an option...'}</option>`;
                param.options.forEach(option => {
                    const selected = option.value === param.defaultValue ? 'selected' : '';
                    fieldHTML += `<option value="${option.value}" ${selected}>${option.label}</option>`;
                });
            }
            fieldHTML += `</select>`;
            break;
            
        case 'radio':
            param.options.forEach((option, index) => {
                const checked = option.value === param.defaultValue ? 'checked' : '';
                fieldHTML += `
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="${param.name}" 
                               id="${fieldId}_${index}" value="${option.value}" ${checked}>
                        <label class="form-check-label" for="${fieldId}_${index}">
                            <strong>${option.label}</strong>
                            ${option.description ? `<br><small class="text-muted">${option.description}</small>` : ''}
                        </label>
                    </div>
                `;
            });
            break;
            
        case 'checkbox':
            const checked = param.defaultValue ? 'checked' : '';
            fieldHTML += `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="${param.name}" 
                           id="${fieldId}" value="true" ${checked}>
                    <label class="form-check-label" for="${fieldId}">
                        ${param.label}
                    </label>
                </div>
            `;
            break;
            
        case 'number':
            fieldHTML += `<input type="number" class="form-control" id="${fieldId}" name="${param.name}"`;
            if (param.required) fieldHTML += ' required';
            if (param.placeholder) fieldHTML += ` placeholder="${param.placeholder}"`;
            if (param.step) fieldHTML += ` step="${param.step}"`;
            if (param.min !== undefined) fieldHTML += ` min="${param.min}"`;
            if (param.max !== undefined) fieldHTML += ` max="${param.max}"`;
            if (param.defaultValue !== undefined) fieldHTML += ` value="${param.defaultValue}"`;
            fieldHTML += `>`;
            break;
            
        case 'text':
            fieldHTML += `<input type="text" class="form-control" id="${fieldId}" name="${param.name}"`;
            if (param.required) fieldHTML += ' required';
            if (param.placeholder) fieldHTML += ` placeholder="${param.placeholder}"`;
            if (param.defaultValue) fieldHTML += ` value="${param.defaultValue}"`;
            fieldHTML += `>`;
            break;
    }
    
    if (param.helpText) {
        fieldHTML += `<div class="form-text">${param.helpText}</div>`;
    }
    
    fieldHTML += `</div>`;
    
    return fieldHTML;
}

function generateCustomReportFields(template) {
    const config = template.config;
    const dataSource = config.data_source || 'orders';
    
    let fieldsHTML = `
        <div class="mb-4">
            <h6 class="fw-bold mb-3">
                <i class="fas fa-cog me-1"></i>
                Custom Report Configuration
            </h6>
            <div class="alert alert-primary">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Data Source:</strong> ${dataSource.charAt(0).toUpperCase() + dataSource.slice(1)}
                <br><small>${template.description || 'Custom configured report'}</small>
            </div>
    `;
    
    // Add data source specific parameters
    if (dataSource === 'orders') {
        fieldsHTML += `
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="orderStatus" class="form-label">Order Status</label>
                        <select class="form-select" id="orderStatus" name="order_status">
                            <option value="">All Statuses</option>
                            <option value="completed">Completed</option>
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Payment Method</label>
                        <select class="form-select" id="paymentMethod" name="payment_method">
                            <option value="">All Payment Methods</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
    } else if (dataSource === 'customers') {
        fieldsHTML += `
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="customerType" class="form-label">Customer Type</label>
                        <select class="form-select" id="customerType" name="customer_type">
                            <option value="">All Customers</option>
                            <option value="active">Active (with orders)</option>
                            <option value="inactive">Inactive (no orders)</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="minOrders" class="form-label">Minimum Orders</label>
                        <input type="number" class="form-control" id="minOrders" name="min_orders" 
                               placeholder="0" min="0">
                    </div>
                </div>
            </div>
        `;
    } else if (dataSource === 'expenses') {
        fieldsHTML += `
            <div class="mb-3">
                <label for="expenseApproval" class="form-label">Approval Status</label>
                <select class="form-select" id="expenseApproval" name="expense_approval">
                    <option value="">All</option>
                    <option value="approved">Approved</option>
                    <option value="pending">Pending</option>
                    <option value="rejected">Rejected</option>
                </select>
            </div>
        `;
    }
    
    fieldsHTML += '</div>';
    
    return fieldsHTML;
}

function addParameterEventListeners(config) {
    // Add event listeners for scope/period selection that affects date fields
    const scopeRadios = document.querySelectorAll('input[name="scope"]');
    const periodRadios = document.querySelectorAll('input[name="period"]');
    
    scopeRadios.forEach(radio => {
        radio.addEventListener('change', () => updateDateFieldsFromScope());
    });
    
    periodRadios.forEach(radio => {
        radio.addEventListener('change', () => updateDateFieldsFromPeriod());
    });
    
    // Initialize date fields if scope/period is already selected
    if (scopeRadios.length > 0) {
        updateDateFieldsFromScope();
    }
    if (periodRadios.length > 0) {
        updateDateFieldsFromPeriod();
    }
}

function updateDateFieldRequirements(config) {
    const dateFromField = document.getElementById('dateFrom');
    const dateToField = document.getElementById('dateTo');
    const dateFromLabel = document.querySelector('label[for="dateFrom"]');
    const dateToLabel = document.querySelector('label[for="dateTo"]');
    const dateFromHelp = document.getElementById('dateFromHelp');
    const dateToHelp = document.getElementById('dateToHelp');
    
    if (config.dateRequired) {
        dateFromField.required = true;
        dateToField.required = true;
        dateFromLabel.innerHTML = 'Date From <span class="text-danger">*</span>';
        dateToLabel.innerHTML = 'Date To <span class="text-danger">*</span>';
        dateFromHelp.textContent = 'Required: Start date for the report data';
        dateToHelp.textContent = 'Required: End date for the report data';
    } else {
        dateFromField.required = false;
        dateToField.required = false;
        dateFromLabel.innerHTML = 'Date From';
        dateToLabel.innerHTML = 'Date To';
        dateFromHelp.textContent = 'Optional: Start date for the report data';
        dateToHelp.textContent = 'Optional: End date for the report data';
    }
    
    // Update based on specific report type
    if (config.title === 'Customer Statement Report') {
        dateFromLabel.textContent = 'Statement From';
        dateToLabel.textContent = 'Statement To';
        dateFromHelp.textContent = 'Optional: Start date for customer statement';
        dateToHelp.textContent = 'Optional: End date for customer statement';
    } else if (config.title === 'Expense Summary Report') {
        dateFromLabel.innerHTML = 'Expense Date From <span class="text-danger">*</span>';
        dateToLabel.innerHTML = 'Expense Date To <span class="text-danger">*</span>';
        dateFromHelp.textContent = 'Required: Start date for expense analysis';
        dateToHelp.textContent = 'Required: End date for expense analysis';
    }
}

// Data loading functions
function loadParameterData(dataSource, fieldName) {
    const urls = {
        'customers': '/customers/api/',
        'expense_categories': '/expenses/api/categories/',
        'service_categories': '/services/api/categories/',
        'payment_methods': '/system-settings/api/payment-methods/'
    };
    
    const url = urls[dataSource];
    if (!url) {
        console.error('Unknown data source:', dataSource);
        return;
    }
    
    fetch(url, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'  // Include session cookies
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            const field = document.getElementById(fieldName);
            if (!field) return;
            
            // Clear existing options except first one
            const firstOption = field.options[0];
            field.innerHTML = '';
            if (firstOption) {
                field.appendChild(firstOption);
            }
            
            const items = data.results || data;
            if (!items || items.length === 0) {
                if (firstOption) {
                    firstOption.textContent = `No ${fieldName.replace('_', ' ')} available`;
                }
                return;
            }
            
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                
                // Format display text based on data source
                if (dataSource === 'customers') {
                    option.textContent = `${item.name} (${item.phone || item.email || 'No contact'})`;
                } else {
                    option.textContent = item.name;
                }
                
                field.appendChild(option);
            });
            
            // Update placeholder
            if (firstOption) {
                firstOption.textContent = `Select ${fieldName.replace('_', ' ')}...`;
            }
        })
        .catch(error => {
            console.error(`Error loading ${dataSource}:`, error);
            const field = document.getElementById(fieldName);
            if (field && field.options[0]) {
                field.options[0].textContent = `Error loading ${dataSource}`;
            }
        });
}

// Date field management functions
function updateDateFieldsFromScope() {
    const scope = document.querySelector('input[name="scope"]:checked')?.value;
    const dateFromField = document.getElementById('dateFrom');
    const dateToField = document.getElementById('dateTo');
    const today = new Date();
    
    if (scope === 'today') {
        const todayStr = today.toISOString().split('T')[0];
        dateFromField.value = todayStr;
        dateToField.value = todayStr;
        dateFromField.disabled = true;
        dateToField.disabled = true;
    } else if (scope === 'week') {
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - today.getDay()); // Sunday
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6); // Saturday
        
        dateFromField.value = weekStart.toISOString().split('T')[0];
        dateToField.value = weekEnd.toISOString().split('T')[0];
        dateFromField.disabled = true;
        dateToField.disabled = true;
    } else if (scope === 'month') {
        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
        const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        dateFromField.value = monthStart.toISOString().split('T')[0];
        dateToField.value = monthEnd.toISOString().split('T')[0];
        dateFromField.disabled = true;
        dateToField.disabled = true;
    } else {
        dateFromField.disabled = false;
        dateToField.disabled = false;
    }
}

function updateDateFieldsFromPeriod() {
    const period = document.querySelector('input[name="period"]:checked')?.value;
    const dateFromField = document.getElementById('dateFrom');
    const dateToField = document.getElementById('dateTo');
    const today = new Date();
    
    if (period === 'this_month') {
        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
        const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        
        dateFromField.value = monthStart.toISOString().split('T')[0];
        dateToField.value = monthEnd.toISOString().split('T')[0];
        dateFromField.disabled = true;
        dateToField.disabled = true;
    } else if (period === 'last_month') {
        const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
        
        dateFromField.value = lastMonthStart.toISOString().split('T')[0];
        dateToField.value = lastMonthEnd.toISOString().split('T')[0];
        dateFromField.disabled = true;
        dateToField.disabled = true;
    } else if (period === 'quarter') {
        const quarterStart = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3, 1);
        const quarterEnd = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3 + 3, 0);
        
        dateFromField.value = quarterStart.toISOString().split('T')[0];
        dateToField.value = quarterEnd.toISOString().split('T')[0];
        dateFromField.disabled = true;
        dateToField.disabled = true;
    } else {
        dateFromField.disabled = false;
        dateToField.disabled = false;
    }
}

// Validation functions
function validateForm() {
    const errors = [];
    const templateSelect = document.getElementById('templateSelect');
    const selectedOption = templateSelect.options[templateSelect.selectedIndex];
    
    if (!selectedOption || !selectedOption.value) {
        errors.push('Please select a report template.');
        return errors;
    }
    
    const reportType = selectedOption.dataset.reportType;
    const config = REPORT_PARAMETER_CONFIGS[reportType];
    
    if (config) {
        // Validate required parameters
        config.parameters.forEach(param => {
            if (param.required) {
                const field = document.getElementById(param.name);
                if (!field) return;
                
                let value = null;
                if (param.type === 'radio') {
                    const checked = document.querySelector(`input[name="${param.name}"]:checked`);
                    value = checked ? checked.value : null;
                } else if (param.type === 'checkbox') {
                    value = field.checked;
                } else {
                    value = field.value;
                }
                
                if (!value || value === '') {
                    errors.push(param.validation?.message || `${param.label} is required.`);
                }
            }
        });
        
        // Validate date requirements
        if (config.dateRequired) {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            if (!dateFrom || !dateTo) {
                errors.push('Both start and end dates are required for this report type.');
            } else if (new Date(dateFrom) > new Date(dateTo)) {
                errors.push('Start date cannot be later than end date.');
            }
        }
    }
    
    return errors;
}

function showValidationMessages(errors) {
    const validationDiv = document.getElementById('validationMessages');
    const validationList = document.getElementById('validationList');
    
    if (errors.length > 0) {
        validationList.innerHTML = '';
        errors.forEach(error => {
            const li = document.createElement('li');
            li.textContent = error;
            validationList.appendChild(li);
        });
        validationDiv.classList.remove('d-none');
        validationDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
        validationDiv.classList.add('d-none');
    }
}

function hideValidationMessages() {
    document.getElementById('validationMessages').classList.add('d-none');
}

function showSuccess(message) {
    const toastEl = document.getElementById('successToast');
    document.getElementById('toastMessage').textContent = message;
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
}

function showError(message) {
    const toastEl = document.getElementById('successToast');
    toastEl.querySelector('.toast-header').innerHTML = '<i class="fas fa-exclamation-circle text-danger me-2"></i><strong class="me-auto">Error</strong><button type="button" class="btn-close" data-bs-dismiss="toast"></button>';
    document.getElementById('toastMessage').textContent = message;
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
}

function generateReport() {
    const btn = document.getElementById('generateReportBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Generating...';

    const formData = new FormData(document.getElementById('generateReportForm'));

    fetch('/reports/ajax/generate/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: formData,
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('Report generated successfully!');
            location.reload();
        } else {
            showError(data.error || 'Failed to generate report.');
        }
    })
    .catch(error => {
        console.error('Error generating report:', error);
        showError('An unexpected error occurred. Please try again.');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-chart-line me-1"></i> Generate Report';
    });
}

function exportReport(reportId, format) {
    // Show loading state for export
    const exportBtn = document.querySelector(`[onclick="exportReport(${reportId}, '${format}')"]`);
    if (exportBtn) {
        const originalText = exportBtn.textContent;
        exportBtn.disabled = true;
        exportBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Exporting...';
        
        // Reset button after a delay
        setTimeout(() => {
            exportBtn.disabled = false;
            exportBtn.innerHTML = originalText;
        }, 3000);
    }
    
    fetch(`/reports/api/generated/${reportId}/export/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ format: format })
    })
    .then(response => response.json())
    .then(result => {
        if (result.export) {
            showSuccess(`Report exported as ${format.toUpperCase()} successfully!`);
        } else {
            showError(result.error || 'Failed to export report. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error exporting report:', error);
        showError('Failed to export report. Please try again.');
    });
}

// Load and display statistics
function loadStats() {
    fetch('/reports/ajax/stats/')
        .then(response => response.json())
        .then(data => {
            console.log('Stats data received:', data);
            
            // Safely update elements only if they exist
            const updateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value || 0;
                }
            };
            
            updateElement('totalReports', data.total_generated);
            updateElement('completedReports', data.completed_reports);
            updateElement('failedReports', data.failed_reports);
            
            // Calculate processing reports
            const processing = Math.max(0, 
                (data.total_generated || 0) - 
                (data.completed_reports || 0) - 
                (data.failed_reports || 0)
            );
            updateElement('processingReports', processing);
        })
        .catch(error => {
            console.error('Error loading stats:', error);
            // Don't show error for stats loading failure
        });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    
    // Set up modal event listeners
    const modal = document.getElementById('generateReportModal');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', function() {
            resetModal();
        });
    }
});

// Additional utility functions
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function formatCurrency(amount) {
    if (amount === null || amount === undefined) return '';
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(amount);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + Enter to generate report when modal is open
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        const modal = document.getElementById('generateReportModal');
        if (modal && modal.classList.contains('show')) {
            e.preventDefault();
            generateReport();
        }
    }
});
</script>
{% endblock %}
